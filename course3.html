<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>COURSE 3 â€“ CODEON</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;text-align:center;padding:30px}
.lesson{background:white;padding:20px;margin:20px auto;width:500px}
.certificate{display:none;background:white;padding:30px;border:5px solid black;margin-top:20px}
button{padding:10px 20px;background:black;color:white;border:none;cursor:pointer}
</style>
</head>
<body>

<h2>COURSE 3 â€“ Advanced Projects</h2>
<div id="accessMessage"></div>

<div id="courseContent" style="display:none">

<div class="lesson">
<h3>Final Project</h3>
<p>Create a SACCO website</p>
<button onclick="completeCourse()">Submit Project</button>
</div>

</div>

<div id="certificate" class="certificate">
<h2>Certificate of Completion</h2>
<p>Name: <span id="certName"></span></p>
<p>Level: Level 3</p>
<p>ID: <span id="certID"></span></p>
<p>Signature: <span id="certHash"></span></p>
<div id="qrcode"></div>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD_LR9Kllj7hoKTiJAaSxyHglSO6r5gh-g",
  authDomain: "codeon-3cb1c.firebaseapp.com",
  projectId: "codeon-3cb1c",
  storageBucket: "codeon-3cb1c.appspot.com",
  messagingSenderId: "730172148868",
  appId: "1:730172148868:web:2c712c8124be40019506d1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ðŸ”’ ACCESS CONTROL
const email = localStorage.getItem("codeonUser");

if(!email){
document.getElementById("accessMessage").innerHTML = "Access Denied. Please enroll first.";
}
else{

db.collection("students").where("email","==",email).get()
.then(snapshot=>{
if(snapshot.empty){
document.getElementById("accessMessage").innerHTML = "User not found.";
return;
}

snapshot.forEach(doc=>{
if(doc.data().paid){
document.getElementById("courseContent").style.display="block";
}
else{
document.getElementById("accessMessage").innerHTML = "Payment Required.";
}
});
});
}

// ðŸŽ“ COMPLETE COURSE
async function completeCourse(){

const snapshot = await db.collection("students")
.where("email","==",email).get();

snapshot.forEach(async doc=>{

const name = doc.data().name;

const id = "CODEON-"+Date.now();
const raw = name+"Level3"+id;

const hashBuffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(raw));
const hashArray = Array.from(new Uint8Array(hashBuffer));
const hash = hashArray.map(b=>b.toString(16).padStart(2,"0")).join("").substring(0,16);

// Save certificate
await db.collection("certificates").doc(id).set({
name,
level:"Level 3",
id,
hash
});

// Show certificate
document.getElementById("certName").innerText = name;
document.getElementById("certID").innerText = id;
document.getElementById("certHash").innerText = hash;
document.getElementById("certificate").style.display="block";

new QRCode(document.getElementById("qrcode"),{
text: window.location.href+"?verify="+id,
width:120,
height:120
});

});

}

function downloadPDF(){
html2pdf().from(document.getElementById("certificate")).save();
}
</script>

</body>
</html>
