<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CODEON Africa Championship</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body{
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  margin:0;
  transition:.3s;
}
header{
  text-align:center;
  padding:20px;
  background:black;
  position:sticky;
  top:0;
  z-index:10;
}
button{
  padding:10px 15px;
  background:gold;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  margin:5px 0;
}
input,textarea,select{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
  border:none;
}
.card{
  background:rgba(255,255,255,0.08);
  padding:20px;
  margin:20px auto;
  border-radius:12px;
  max-width:900px;
  transition:.3s;
}
.leader-row{
  display:flex;
  justify-content:space-between;
  padding:6px;
  border-bottom:1px solid rgba(255,255,255,.2);
  transition:.3s;
}
.badge{
  background:gold;
  color:black;
  padding:3px 6px;
  border-radius:5px;
  font-size:12px;
  margin-right:4px;
}
.error{color:red;}
.progress-container{
  background:#333;
  border-radius:10px;
  height:12px;
  margin-top:10px;
}
.progress-bar{
  background:gold;
  height:12px;
  width:0%;
  border-radius:10px;
  transition:.5s;
}
@media(max-width:600px){.leader-row{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>

<header>
<h1>üèÜ CODEON Africa Championship</h1>
<div id="countdown"></div>
</header>

<section id="authSection">
<div class="card">
<h2>Login / Sign Up</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<input type="text" id="username" placeholder="Username">
<input type="text" id="school" placeholder="School Name">
<select id="country">
  <option value="Uganda">Uganda</option>
  <option value="Kenya">Kenya</option>
  <option value="Nigeria">Nigeria</option>
  <option value="Ghana">Ghana</option>
  <option value="South Africa">South Africa</option>
</select>
<button onclick="signup()">Sign Up</button>
<button onclick="login()">Login</button>
<p id="authError" class="error"></p>
</div>
</section>

<section id="main" style="display:none;">

<div class="card">
<h2>Dashboard</h2>
<p id="welcome"></p>
<p>Points: <strong id="points">0</strong></p>
<p>Level: <strong id="level">1</strong></p>
<div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
<p>Streak: <strong id="streak">0</strong> üî•</p>
<div id="badges"></div>
<button onclick="claimBonus()">Claim Daily Bonus</button>
<p id="bonusMsg"></p>
<button onclick="logout()">Logout</button>
</div>

<div class="card">
<h2>Weekly Challenge</h2>
<select id="difficulty">
<option value="Easy">Easy (+50 XP)</option>
<option value="Medium">Medium (+100 XP)</option>
<option value="Hard">Hard (+200 XP)</option>
</select>
<textarea id="challengeCode" placeholder="Write your HTML/CSS here..."></textarea>
<button onclick="submitChallenge()">Submit Challenge</button>
<p id="challengeMsg"></p>
</div>

<div class="card">
<h2>Leaderboards</h2>
<h3>Global</h3>
<div id="leaderboard"></div>
<h3>School</h3>
<div id="schoolBoard"></div>
<h3>Country</h3>
<div id="countryBoard"></div>
</div>

<div class="card" id="adminPanel" style="display:none;">
<h2>Admin Panel</h2>
<p>Mark any user‚Äôs streak or points:</p>
<input type="text" id="adminEmail" placeholder="User email">
<input type="number" id="adminPoints" placeholder="Set points">
<input type="number" id="adminStreak" placeholder="Set streak">
<button onclick="adminUpdate()">Update User</button>
<p id="adminMsg"></p>
</div>

</section>

<script>
// Firebase Config
firebase.initializeApp({
  apiKey:"AIzaSyD_LR9Kllj7hoKTiJAaSxyHglSO6r5gh-g",
  authDomain:"codeon-3cb1c.firebaseapp.com",
  projectId:"codeon-3cb1c"
});
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
const admins=["admin@example.com"]; // hardcoded admin

// Countdown for 30-day season
function startCountdown(){
  const end=new Date();
  end.setDate(end.getDate()+30);
  setInterval(()=>{
    const diff=end-new Date();
    const days=Math.floor(diff/(1000*60*60*24));
    countdown.innerText="Season ends in "+days+" days";
  },1000);
}
startCountdown();

// Signup
function signup(){
  const emailVal=email.value.trim();
  const passwordVal=password.value;
  const usernameVal=username.value.trim();
  const schoolVal=school.value.trim();
  const countryVal=country.value;

  if(!emailVal||!passwordVal||!usernameVal||!schoolVal) {authError.innerText="All fields required"; return;}

  auth.createUserWithEmailAndPassword(emailVal,passwordVal)
  .then(user=>{
    return db.collection("users").doc(user.user.uid).set({
      email:emailVal,
      username:usernameVal,
      school:schoolVal,
      country:countryVal,
      points:0,
      level:1,
      streak:0,
      lastSubmit:null,
      lastBonus:null,
      joinDate:new Date().toISOString()
    });
  })
  .catch(e=>authError.innerText=e.message);
}

// Login
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>authError.innerText=e.message);
}

// Logout
function logout(){auth.signOut();}

// Auth state
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    authSection.style.display="none";
    main.style.display="block";
    if(admins.includes(user.email)) adminPanel.style.display="block";
    loadUser();
    loadLeaderboards();
  } else {
    authSection.style.display="block";
    main.style.display="none";
    adminPanel.style.display="none";
  }
});

// Calculate XP from challenge
function getXP(difficulty){
  if(difficulty==="Easy") return 50;
  if(difficulty==="Medium") return 100;
  if(difficulty==="Hard") return 200;
  return 50;
}

// Submit challenge
function submitChallenge(){
  const xp=getXP(difficulty.value);
  const ref=db.collection("users").doc(currentUser.uid);
  const today=new Date().toDateString();

  ref.get().then(doc=>{
    let data=doc.data();
    if(data.lastSubmit===today){
      challengeMsg.innerText="Already submitted today!";
      return;
    }
    const newPoints=(data.points||0)+xp;
    const newStreak=(data.lastSubmit===today)?data.streak:data.streak+1;
    const newLevel=Math.floor(newPoints/200)+1;
    ref.update({points:newPoints,streak:newStreak,lastSubmit:today,level:newLevel});
    challengeMsg.innerText="‚úÖ +" + xp + " XP earned!";
  });
}

// Claim daily bonus
function claimBonus(){
  const today=new Date().toDateString();
  const ref=db.collection("users").doc(currentUser.uid);
  ref.get().then(doc=>{
    let d=doc.data();
    if(d.lastBonus===today){bonusMsg.innerText="Bonus already claimed today"; return;}
    const newPoints=(d.points||0)+20;
    ref.update({points:newPoints,lastBonus:today});
    bonusMsg.innerText="üî• +20 Daily Bonus XP!";
  });
}

// Load dashboard user info
function loadUser(){
  db.collection("users").doc(currentUser.uid).onSnapshot(doc=>{
    const d=doc.data();
    welcome.innerText="Welcome "+d.username+" | Rank calculating...";
    points.innerText=d.points||0;
    level.innerText=d.level||1;
    streak.innerText=d.streak||0;

    // Progress bar
    const percent=((d.points||0)%200)/200*100;
    progressBar.style.width=percent+"%";

    // Badges
    let badgeHTML="";
    if(d.points>100) badgeHTML+="<span class='badge'>Rising Star</span>";
    if(d.points>300) badgeHTML+="<span class='badge'>Elite Coder</span>";
    if(d.points>600) badgeHTML+="<span class='badge'>Africa Finalist</span>";
    badges.innerHTML=badgeHTML;

    // Rank
    db.collection("users").orderBy("points","desc").get().then(snap=>{
      let rank=1;
      snap.forEach(u=>{
        if(u.id===currentUser.uid) welcome.innerText+=" | Rank #"+rank;
        rank++;
      });
    });
  });
}

// Load leaderboards
function loadLeaderboards(){
  db.collection("users").onSnapshot(snapshot=>{
    const users=[];
    snapshot.forEach(doc=>{users.push(doc.data());});

    // Global
    leaderboard.innerHTML="";
    users.sort((a,b)=>b.points-a.points).slice(0,10).forEach((u,i)=>{
      leaderboard.innerHTML+=`<div class="leader-row">${i+1}. ${u.username} (${u.points} pts)</div>`;
    });

    // School
    const mySchool=users.find(u=>u.email===currentUser.email).school;
    schoolBoard.innerHTML="";
    users.filter(u=>u.school===mySchool).sort((a,b)=>b.points-a.points).slice(0,10)
      .forEach((u,i)=>schoolBoard.innerHTML+=`<div class="leader-row">${i+1}. ${u.username} (${u.points} pts)</div>`);

    // Country
    const myCountry=users.find(u=>u.email===currentUser.email).country;
    countryBoard.innerHTML="";
    users.filter(u=>u.country===myCountry).sort((a,b)=>b.points-a.points).slice(0,10)
      .forEach((u,i)=>countryBoard.innerHTML+=`<div class="leader-row">${i+1}. ${u.username} (${u.points} pts)</div>`);
  });
}

// Admin updates
function adminUpdate(){
  const emailTo=adminEmail.value.trim();
  const pts=parseInt(adminPoints.value);
  const strk=parseInt(adminStreak.value);
  db.collection("users").where("email","==",emailTo).get().then(snap=>{
    snap.forEach(doc=>{
      doc.ref.update({points:pts,streak:strk});
      adminMsg.innerText="User updated!";
    });
  });
}
</script>

</body>
</html>
