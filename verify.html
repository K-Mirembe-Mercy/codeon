<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Membership Form</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  h1, h2 { text-align: center; }
  form { max-width: 500px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; }
  input, select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 4px; border: 1px solid #ccc; }
  .partners { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 30px; }
  .badge { background: #4CAF50; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
</style>
</head>
<body>

<h1>Membership Registration</h1>
<form id="membershipForm">
  <label>Full Name:</label>
  <input type="text" id="fullName" required>

  <label>Email:</label>
  <input type="email" id="email" required>

  <label>Type:</label>
  <select id="type" required>
    <option value="">Select</option>
    <option value="Individual">Individual</option>
    <option value="School">School</option>
  </select>

  <label>School Name (if School):</label>
  <input type="text" id="schoolName">

  <button type="submit">Submit & Pay</button>
</form>

<h2>Our Partners</h2>
<div class="partners" id="partners"></div>

<h2>Members List</h2>
<table id="membersTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Type</th>
      <th>School</th>
      <th>Certificate Sent</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // === CONFIGURE THESE ===
  const EMAILJS_USER_ID = 'YOUR_EMAILJS_USER_ID';
  const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
  const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';
  const GOOGLE_SHEET_WEBAPP_URL = 'YOUR_GOOGLE_SHEET_WEBAPP_URL';
  emailjs.init(EMAILJS_USER_ID);

  const members = [];
  const partnersDiv = document.getElementById('partners');
  const membersTableBody = document.querySelector('#membersTable tbody');

  document.getElementById('membershipForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fullName = document.getElementById('fullName').value;
    const email = document.getElementById('email').value;
    const type = document.getElementById('type').value;
    const schoolName = document.getElementById('schoolName').value;

    if (!fullName || !email || !type) {
      alert('Please fill in all required fields!');
      return;
    }

    // Redirect to PesaPal payment
    alert('You will be redirected to the payment page. After payment, click OK.');
    window.open('https://store.pesapal.com/subscribecodeon', '_blank');

    // Simulate payment success (replace with webhook in production)
    const paid = true; 

    if(paid) {
      // Generate PDF certificate as blob
      const certificateBlob = await generateCertificateBlob(fullName, type, schoolName);

      // Send certificate via EmailJS
      sendEmailWithCertificate(email, fullName, certificateBlob);

      // Add to members list (in-page)
      const member = { fullName, email, type, schoolName, certificate: 'Sent' };
      members.push(member);
      updateMembersTable();

      // Add badge if school
      if (type === 'School') addPartnerBadge(schoolName || fullName);

      // Save to Google Sheet
      saveMemberOnline(member);

      // Reset form
      document.getElementById('membershipForm').reset();
    }
  });

  async function generateCertificateBlob(name, type, school) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(22);
    doc.text('Certificate of Membership', 20, 30);
    doc.setFontSize(16);
    doc.text(`This certifies that ${name}`, 20, 50);
    if(type === 'School') doc.text(`from ${school}`, 20, 60);
    doc.text('is a valued member of our organization.', 20, 70);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 90);
    return doc.output('blob');
  }

  function sendEmailWithCertificate(email, name, blob) {
    const reader = new FileReader();
    reader.onload = function() {
      const base64 = reader.result.split(',')[1];
      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email: email,
        to_name: name,
        attachment: base64
      }).then(function(response){
        alert(`Certificate emailed to ${email}!`);
      }, function(error){
        alert('Email failed: '+error);
      });
    };
    reader.readAsDataURL(blob);
  }

  function addPartnerBadge(name) {
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = name;
    partnersDiv.appendChild(badge);
  }

  function updateMembersTable() {
    membersTableBody.innerHTML = '';
    members.forEach(m => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m.fullName}</td>
        <td>${m.email}</td>
        <td>${m.type}</td>
        <td>${m.schoolName || '-'}</td>
        <td>${m.certificate}</td>
      `;
      membersTableBody.appendChild(row);
    });
  }

  function saveMemberOnline(member) {
    fetch(GOOGLE_SHEET_WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify(member),
      headers: {'Content-Type': 'application/json'}
    }).then(res => res.json())
      .then(data => console.log('Saved to Google Sheet', data))
      .catch(err => console.error('Error saving to Google Sheet:', err));
  }
</script>

</body>
</html>